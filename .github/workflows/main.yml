name: Build

on:
  push:
    branches:
      - main
      - master
    tags:
      - v*
  pull_request:
    branches:
      - main
      - master

jobs:
  # 测试阶段
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run quota tests
        run: |
          chmod +x tests/*.sh
          ./tests/run_all.sh

  # 构建阶段（仅在 tag 推送时）
  # 注：LUCI_PKGARCH=all，ipk 全平台通用，只需构建一个架构
  build:
    name: Build Package
    runs-on: ubuntu-latest
    needs: test
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version from tag
        run: |
          # Extract version from tag (v4.0.3 -> 4.0.3)
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # Update Makefile
          sed -i "s/^PKG_VERSION:=.*/PKG_VERSION:=$VERSION/" luci-app-timecontrol/Makefile

          # Update PKG_RELEASE to current date
          RELEASE_DATE=$(date +%Y%m%d)
          sed -i "s/^PKG_RELEASE:=.*/PKG_RELEASE:=$RELEASE_DATE/" luci-app-timecontrol/Makefile

          echo "Updated version to $VERSION-$RELEASE_DATE"
          grep -E "^PKG_(VERSION|RELEASE)" luci-app-timecontrol/Makefile

      - name: Building packages
        uses: sbwml/openwrt-gh-action-sdk@go1.24
        env:
          ARCH: x86_64-openwrt-24.10
          FEEDNAME: packages_ci
          PACKAGES: luci-app-timecontrol
          NO_REFRESH_CHECK: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-timecontrol
          path: bin/packages/x86_64/packages_ci/*.ipk

      - name: Upload packages
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "bin/packages/x86_64/packages_ci/*.ipk"

  # 更新 opkg 源 (gh-pages)
  update-opkg-repo:
    name: Update opkg Repository
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download ipk from release
        run: |
          mkdir -p repo
          cd repo
          # Get latest release tag
          TAG="${GITHUB_REF#refs/tags/}"
          # Download all ipk files from this release
          gh release download "$TAG" --pattern "*.ipk" --repo "$GITHUB_REPOSITORY"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Packages index
        run: |
          cd repo
          for ipk in *.ipk; do
            [ -f "$ipk" ] || continue
            mkdir -p _tmp
            tar -xzf "$ipk" -C _tmp 2>/dev/null || tar -xf "$ipk" -C _tmp
            tar -xzf _tmp/control.tar.gz -C _tmp 2>/dev/null || tar -xf _tmp/control.tar.* -C _tmp
            cat _tmp/control
            echo "Filename: $ipk"
            echo "Size: $(stat -c%s "$ipk")"
            echo "SHA256sum: $(sha256sum "$ipk" | cut -d' ' -f1)"
            echo ""
            rm -rf _tmp
          done > Packages
          gzip -k Packages

      - name: Build usign and sign Packages
        run: |
          # Build usign
          git clone https://git.openwrt.org/project/usign.git /tmp/usign
          cd /tmp/usign && cmake . && make

          # Write secret key to file
          echo "${{ secrets.USIGN_SECRET_KEY }}" > /tmp/usign.sec

          # Sign Packages file
          cd $GITHUB_WORKSPACE/repo
          /tmp/usign/usign -S -m Packages -s /tmp/usign.sec

          # Create public key file for users
          cat > key-build.pub << 'PUBKEY'
          untrusted comment: TimouL OpenWrt Packages
          RWROByDpfEOBjY0D2nN1tHVfNvmRmI6itPiVQMR+Li78P22JqT+4luBZ
          PUBKEY

          # Cleanup
          rm -f /tmp/usign.sec

      - name: Create README
        run: |
          cat > repo/README.md << 'EOF'
          # luci-app-timecontrol opkg 源

          ## 首次使用：添加公钥

          ```bash
          wget -O /tmp/timecontrol.pub https://timoul.github.io/luci-app-timecontrol/key-build.pub
          opkg-key add /tmp/timecontrol.pub
          ```

          ## 添加源

          ```bash
          echo "src/gz timecontrol https://timoul.github.io/luci-app-timecontrol" >> /etc/opkg/customfeeds.conf
          ```

          ## 安装

          ```bash
          opkg update
          opkg install luci-app-timecontrol luci-i18n-timecontrol-zh-cn
          ```
          EOF

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo
          publish_branch: gh-pages
          force_orphan: true
          commit_message: "chore: update opkg repo to ${{ github.ref_name }}"
